<html>

<head>
	<link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body style="background:#7ED87C;">
<a href = "/index.html"><h2>MainPage</h2></a>
<h3  >Join Vote</h3>
<p class="text-danger"><b><em>Score Rules:
<li class="text-danger">1, All the input number should between 0~9</li>
<li class="text-danger">2, You should input one and only one 9 score,one or more than one 0 score. And other score .</li>
</em></b></P>
<div>
<label>Vote Select :</label>
<select class='combobox form-control' name='inline' id="VoteNumberCombo" style="width:250" onchange="RefreshTable()">
</select>
</div>

<table class="table" action="SubmitVote" >
<thread>
<tr>
<th>Name</th>
<th>Content</th>
<th>Score</th>
</tr>
</thread>
<tbody id = "TableBody">

</tbody>
</table>
<div>
<input type="submit" value="submit score" class="btn btn-lg btn-default" id='SubmitBtn' onclick="SendScore()"/>
</div>

</body>
 <script src="node_modules/jquery/dist/jquery.min.js"></script>
<script>
var addInput = "<tr>\
<td>\
<label for='firstname' class='PersonNameLabel'>Person Name</label>\
</td>\
<td>\
<label for='firstname' class='PersonContentLabel'>Person Content</label>\
</td>\
<td>\
<input class='PersonScoreInput' type='text' style='width:50px;' />\
</td>\
</tr>";
var VoteContent;
var AddPerson = function(){
	console.log("add person");
        $("#TableBody").append(addInput);
};
var UserName;
var GetData = function(){
        $.get("GetAllVoteContent",function(result){
		console.log(JSON.parse(result));
                VoteContent = JSON.parse(result);//all the votes
                for(var m=0;m<VoteContent.Votes.length;m++)
                {
                    var option=$("<option ></option>").text(VoteContent.Votes[m].Date);
                    $("#VoteNumberCombo").append(option);
                }
                /*
                for(var n=0;n<VoteContent.Votes[0].Persons.length;n++)
                {
                    var row = $("<tr class='VoteRow'></tr>");
                    var col1 = $("<td class='PersonNameCol'></td>");
                    var col1content = $("<label class ='PersonNameLabel'></label>").text(VoteContent.Votes[0].Persons[n].PersonName);
                    var col2 =     $("<td></td>");
                    var col2content = $("<label></label>").text(VoteContent.Votes[0].Persons[n].PersonContent);
                    var col3 = $("<td class='ScoreCol'></td>");
                    var col3content = $("<input class='PersonScoreInput' type='text' style='width:50px;' />");
                    col1.append(col1content);
                    col2.append(col2content);
                    col3.append(col3content);
                    row.append(col1,col2,col3);
                    $("#TableBody").append(row);
                }
                */
                RefreshTable();
        });
};
var GetVotedStatus=function(){
        $.get("GetVoteStatus",function(result){
                console.log(result);//User Name
                UserName = result;
                 var _date = $("#VoteNumberCombo").find("option:selected").text();
                 console.log("date ="+_date);
                var flag =0;
                for(var i =0;i<VoteContent.Votes.length;i++)
                {
                    if(VoteContent.Votes[i].Date==_date)
                    {
                        for(var j=0;j<VoteContent.Votes[i].VoteStatus.length;j++)
                        {
                            if(VoteContent.Votes[i].VoteStatus[j].PersonName ==result )
                            {
                                flag=1;
                                if(VoteContent.Votes[i].VoteStatus[j].HasVoted=="Voted")
                                {
                                     $('#SubmitBtn').attr('disabled','true');
                                }else{
                                      $('#SubmitBtn').removeAttr('disabled');
                                }

                            }
                        }
                        if(flag==0)
                        {
                        //do not have this person
                        console.log("do not have this person");
                            $('#SubmitBtn').attr('disabled','true');
                        }
                        break;
                    }
                }
        });
};
var SendScore = function(){
		var flag9=0;
		var flag0 = 0;
                var _date = $("#VoteNumberCombo").find("option:selected").text();
                var _Scores = {'Scores':[],'Date':_date};
                console.log("SendScore!");
                $(".VoteRow").each(function(){
                   var Input = $(this).children(".ScoreCol").eq(0).children(".PersonScoreInput").eq(0);
                   var Name = $(this).children(".PersonNameCol").eq(0).children(".PersonNameLabel").eq(0);
                   console.log("Scores = "+Input);
                   if(Input.val()=="")
                   {
                           alert("Please input score for all the people!");
                           return;
                   }
                   else if(parseInt(Input.val())>9 || parseInt(Input.val())<0)
                   {
                           alert("Score should be between 0~9!");
                           return;
                   }
                   else if(parseInt(Input.val())==9)
                   {
                           if(flag9==0)
                           {
                                   flag9=1;
                           }
                           else
                           {
                                   alert("Just allow one '9' in scores!");
                                   return ;
                           }
                   }
                   else if(parseInt(Input.val())==0)
                   {
                           flag0=1;
                   }
                   var _Score= {"PersonName":Name.text(),"Score":Input.val()};
                   console.log ("Every Person : "+_Score.PersonName);
                  _Scores.Scores[_Scores.Scores.length]=_Score;
                   console.log("Scores ==  "+_Scores);
                });
		if(flag9==0)//Do not have one 9
		{
			alert("You should input at least one 9 score!");
			return;
		}
		else if(flag0==0)
		{
			alert("You should input at least one 0 score!");
			return;
		}
                $.post("SendScore",{data:JSON.stringify(_Scores)},function(result){
                if(result=="Error")//do not have permission to vote
                {
                    console.log("vote error");
                    $('#SubmitBtn').attr('disabled','true');
                }else{
                       console.log("Post score success!");
                       window.location.href ="JoinVotePage.html";
                       }
                });
}

var RefreshTable=function(){
    console.log("refresh table!!!");
    //Clear the table
    $("#TableBody").empty();
 $.get("GetVoteStatus",function(result){
     _UserName =result;

    var _date = $("#VoteNumberCombo").find("option:selected").text();
    console.log(_date);
    //Add table body
    for(var m=0;m<VoteContent.Votes.length;m++)
    {
        if(VoteContent.Votes[m].Date == _date)
        {
            for(var p=0;p<VoteContent.Votes[m].Persons.length;p++)
            {
            var _PersonName = VoteContent.Votes[m].Persons[p].PersonName;
            console.log("current user  = ",UserName);
            if(_PersonName == _UserName)//if is current user
            {
                continue;
            }
            var row = $("<tr class='VoteRow'></tr>");
            var col1 = $("<td class='PersonNameCol'></td>");
            var col1content = $("<label class ='PersonNameLabel'></label>").text(_PersonName);
            var col2 =     $("<td></td>");
            var col2content = $("<label></label>").text(VoteContent.Votes[m].Persons[p].PersonContent);
            var col3 = $("<td class='ScoreCol'></td>");
            var col3content = $("<input class='PersonScoreInput' type='text' style='width:50px;' />");
            col1.append(col1content);
            col2.append(col2content);
            col3.append(col3content);
            row.append(col1,col2,col3);
            $("#TableBody").append(row);
            }
            break;
        }

    }
            GetVotedStatus();
    });
};
GetData();
</script>
</html>
